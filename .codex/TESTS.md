**テスト観点サマリー**

- **対象**: `typing.sh`（タイピングゲーム本体）と公開関数 `typingGame`。
- **フレームワーク**: Bats（`tests/typing.bats`）。全 22 ケース。
- **実行方法**:
  - ローカル: `bats -r tests`
  - Make: `make ci`（環境により Docker 経由の実行も可）

**正常系（基本動作）**
- **単語1件**: 正しい入力で完了（`CONTENT="abc"` → 入力 `abc`）。
- **ミスタイプ無視**: 先頭に誤入力があっても、正しいシーケンスで完了（`xabc`）。
- **複数語連結入力**: 2語を連結した入力で連続完了（`ab cd` → 入力 `abcd`）。
- **WORDS_FILE**: 外部ファイル経由の出題で完了（`WORDS_FILE=tmp`）。
- **-f 優先**: `CONTENT` より `-f` が優先されて完了。
- **-c 制限**: 出題数を 1 に制限して完了。
- **-r シャッフル**: 重複語でも完了（順序非依存で成功）。
- **関数呼び出し**: `source` 後に `typingGame -c 1` で完了。

**異常系（エラー処理）**
- **不正オプション**: 未知の `-z` で終了コード 2 とエラーメッセージ。
- **-f 引数欠落**: 引数不足で終了コード 2 とエラーメッセージ。
- **-c 不正値(0/非数)**: 終了コード 2 とガイド文言（正の整数要求）。

**入力正規化**
- **CRLF/コメント/空行**: `-f` で CRLF とコメント・空行を含むファイルでも正しくフィルタされ完了。

**出題制御**
- **-c > 語数**: 出題数が総語数を超えても問題なく完了。
- **SHUFFLE=1 かつ shuf 不在**: `PATH` から `shuf` を隠しても完了（順序維持で成功）。

**表示/出力**
- **ミスタイプ時の期待文字**: 「期待: <文字>」の表示を確認。
- **完了メッセージ**: 「完了しました」の表示を確認。
- **最終ステータス**: 「単語: n/n」形式の出力を確認。
- **非TTY時の制御コード抑制**: カーソル表示/非表示コード（`[?25l`,`[?25h`）が出力されない。

**source 安全性（回帰防止）**
- **set -o の復元**: `source typing.sh` 実行前後で `set -o` 状態が同一。
- **IFS の復元**: 実行前後で `IFS` が同一。

**補足**
- `typingGame` 内で `set -Eeuo pipefail` を一時的に有効化し、関数末尾で元のシェルオプション（`set +o` の退避/復元）と `IFS`/`trap` を復元することで、`source` 実行時にも親シェルを汚染しません。

